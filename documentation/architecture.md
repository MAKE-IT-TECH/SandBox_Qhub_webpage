# QHub PoC — System Architecture

## 1. High-Level Architecture

```mermaid
graph TB
    subgraph Client["Browser (SPA)"]
        UI["index.html<br/>Vanilla JS + Chart.js"]
    end

    subgraph Server["FastAPI Backend"]
        API["server.py<br/>REST API + SSE"]
        AUTH["auth.py<br/>JWT Auth"]
        ENGINE["agent_engine.py<br/>Agent Orchestrator"]
        TOOLS["tools.py<br/>Tool Functions"]
    end

    subgraph External["External Services"]
        CLAUDE["Anthropic API<br/>Claude Sonnet"]
    end

    subgraph Storage["Data Layer"]
        DB["SQLite<br/>qhub.db"]
        CSV["defeitos.csv<br/>Factory Data"]
    end

    UI -- "HTTP/JSON + SSE" --> API
    API -- "JWT verify" --> AUTH
    AUTH -- "user lookup" --> DB
    API -- "process_message()" --> ENGINE
    ENGINE -- "tool_use loop" --> CLAUDE
    ENGINE -- "execute tools" --> TOOLS
    ENGINE -- "read/write" --> DB
    TOOLS -- "read" --> CSV
    API -- "CRUD" --> DB
    API -- "serve static" --> UI

    style Client fill:#e8f0fe,stroke:#1a73e8
    style Server fill:#f0f7ff,stroke:#1a73e8
    style External fill:#fff3e0,stroke:#f9ab00
    style Storage fill:#e8f5e9,stroke:#1e8e3e
```

## 2. Entity Relationship Diagram

```mermaid
erDiagram
    users {
        int id PK
        text nome
        text email UK
        text password_hash
        text role "admin | operadora | responsavel"
    }

    agentes {
        int id PK
        text nome
        text system_prompt "Agent behavior / skills"
        text tools "JSON array of tool names"
    }

    user_agentes {
        int user_id FK
        int agente_id FK
    }

    conversas {
        int id PK
        int user_id FK
        int agente_id FK
        text created_at
    }

    mensagens {
        int id PK
        int conversa_id FK
        text role "user | assistant"
        text content
        text timestamp
    }

    dashboards {
        text id PK "uuid hex"
        int user_id FK
        text titulo
        text html "Full dashboard HTML"
        text created_at
    }

    users ||--o{ user_agentes : "has access to"
    agentes ||--o{ user_agentes : "accessible by"
    users ||--o{ conversas : "owns"
    agentes ||--o{ conversas : "bound to"
    conversas ||--o{ mensagens : "contains"
    users ||--o{ dashboards : "generated by"
```

## 3. API Endpoints Map

```mermaid
graph LR
    subgraph Public
        LOGIN["POST /auth/login"]
        DASH_VIEW["GET /dashboards/:id"]
    end

    subgraph Authenticated["Authenticated (JWT)"]
        AG_LIST["GET /agentes"]
        CONV_CREATE["POST /conversas"]
        CONV_LIST["GET /conversas"]
        MSG_LIST["GET /conversas/:id/mensagens"]
        MSG_SEND["POST /conversas/:id/mensagens<br/>(SSE stream)"]
    end

    subgraph Admin["Admin Only (role=admin)"]
        ADM_AG["GET/POST /admin/agentes<br/>PUT/DELETE /admin/agentes/:id"]
        ADM_TOOLS["GET /admin/tools"]
        ADM_USERS["GET/POST /admin/users<br/>PUT/DELETE /admin/users/:id"]
        ADM_UA["GET/PUT /admin/users/:id/agentes"]
    end

    LOGIN --> |"returns JWT"| Authenticated
    Authenticated --> |"role check"| Admin

    style Public fill:#e8f5e9,stroke:#1e8e3e
    style Authenticated fill:#e8f0fe,stroke:#1a73e8
    style Admin fill:#fce4ec,stroke:#e8453c
```

## 4. Chat Message Flow (SSE Streaming + Tool Use Loop)

```mermaid
sequenceDiagram
    participant U as Browser
    participant S as server.py
    participant E as agent_engine.py
    participant C as Claude API
    participant T as tools.py
    participant DB as SQLite

    U->>S: POST /conversas/:id/mensagens
    S->>E: process_message(user_id, conversa_id, text)

    E->>DB: Save user message
    E->>DB: Load conversation history
    E->>DB: Load agent config (prompt + tools)

    loop Tool Use Loop (max 8 iterations)
        E->>C: messages.stream(model, system, messages, tools)

        loop Text Streaming
            C-->>E: text delta
            E-->>S: SSE: {"type":"text", "content":"..."}
            S-->>U: Stream text chunk
        end

        alt Claude calls a tool
            C-->>E: tool_use block

            alt Data Tool (contar_defeitos, top_defeitos, etc.)
                E->>T: execute tool(**input)
                T->>T: Read defeitos.csv
                T-->>E: data result
                E-->>U: SSE: {"type":"tool_use", "name":"...", "result":{}}
            end

            alt Render Tool (gerar_grafico, gerar_tabela, gerar_kpi)
                E->>T: execute tool(**input)
                T-->>E: widget config
                E-->>U: SSE: {"type":"chart|table|kpi", "data":{}}
            end

            alt Dashboard Tool (gerar_dashboard)
                E->>T: gerar_dashboard(titulo, html)
                T-->>E: {titulo, html}
                E->>DB: INSERT INTO dashboards
                E-->>U: SSE: {"type":"dashboard", "url":"/dashboards/abc123"}
            end

            Note over E,C: Append tool_result to messages, continue loop
        else Claude returns final text
            Note over E: Break loop
        end
    end

    E->>DB: Save assistant response
    E-->>U: SSE: {"type":"done"}
```

## 5. Authentication & Authorization Flow

```mermaid
flowchart TD
    A[User opens app] --> B[Login form]
    B --> C[POST /auth/login<br/>email + password]
    C --> D{auth.py:<br/>bcrypt verify}

    D -->|Invalid| E[401 Unauthorized]
    D -->|Valid| F[Generate JWT<br/>user_id + nome + role<br/>expires 8h]

    F --> G[Store token in JS variable]
    G --> H{Check role}

    H -->|operadora / responsavel| I[Chat View<br/>Agents + Conversations]
    H -->|admin| J[Chat View + Admin Panel<br/>Agents + Users + Tools mgmt]

    subgraph "API Request Flow"
        K[Any API call] --> L[Authorization: Bearer token]
        L --> M{get_current_user}
        M -->|Invalid/expired| N[401]
        M -->|Valid| O{Admin endpoint?}
        O -->|No| P[Process normally]
        O -->|Yes| Q{require_admin<br/>role == admin?}
        Q -->|No| R[403 Forbidden]
        Q -->|Yes| S[Process admin request]
    end

    style E fill:#fce4ec,stroke:#e8453c
    style N fill:#fce4ec,stroke:#e8453c
    style R fill:#fce4ec,stroke:#e8453c
    style J fill:#e8f0fe,stroke:#1a73e8
```

## 6. Frontend Rendering Pipeline

```mermaid
flowchart LR
    subgraph SSE["SSE Events from Backend"]
        EVT_TEXT["type: text"]
        EVT_CHART["type: chart"]
        EVT_TABLE["type: table"]
        EVT_KPI["type: kpi"]
        EVT_DASH["type: dashboard"]
        EVT_TOOL["type: tool_use"]
        EVT_ERR["type: error"]
    end

    subgraph Render["Frontend Renderers"]
        R_TEXT["Append to .msg.assistant"]
        R_CHART["renderChart()<br/>Chart.js canvas"]
        R_TABLE["renderTable()<br/>HTML table"]
        R_KPI["renderKpi()<br/>KPI card"]
        R_DASH["renderDashboardLink()<br/>Sandboxed iframe"]
        R_TOOL["addMessage('tool')"]
        R_ERR["addMessage('error')"]
    end

    subgraph Output["Chat Output"]
        O_TEXT["Text bubble"]
        O_CHART["Bar / Pie / Line / Doughnut"]
        O_TABLE["Styled table"]
        O_KPI["Gradient KPI card"]
        O_DASH["Inline iframe<br/>sandbox=allow-scripts<br/>+ open in new tab"]
        O_TOOL["Tool indicator"]
        O_ERR["Error message"]
    end

    EVT_TEXT --> R_TEXT --> O_TEXT
    EVT_CHART --> R_CHART --> O_CHART
    EVT_TABLE --> R_TABLE --> O_TABLE
    EVT_KPI --> R_KPI --> O_KPI
    EVT_DASH --> R_DASH --> O_DASH
    EVT_TOOL --> R_TOOL --> O_TOOL
    EVT_ERR --> R_ERR --> O_ERR

    style SSE fill:#fff3e0,stroke:#f9ab00
    style Render fill:#e8f0fe,stroke:#1a73e8
    style Output fill:#e8f5e9,stroke:#1e8e3e
```

## 7. File Structure

```mermaid
graph TD
    subgraph Root["Project Root"]
        SERVER["server.py<br/>FastAPI app + admin endpoints"]
        ENGINE["agent_engine.py<br/>Claude API + tool loop"]
        TOOLS["tools.py<br/>Data queries + render tools"]
        DB_PY["db.py<br/>SQLite schema + seed"]
        AUTH_PY["auth.py<br/>JWT auth"]
        REQ["requirements.txt"]
    end

    subgraph Static["static/"]
        INDEX["index.html<br/>SPA: chat + admin panel"]
    end

    subgraph Data["data/"]
        CSV["defeitos.csv<br/>200 rows of factory data"]
    end

    subgraph Docs["documentation/"]
        ARCH["architecture.md<br/>This file"]
    end

    subgraph Runtime["Runtime (generated)"]
        SQLITE["qhub.db<br/>SQLite database"]
        VENV["venv/<br/>Python packages"]
    end

    SERVER --> ENGINE
    SERVER --> AUTH_PY
    SERVER --> DB_PY
    ENGINE --> TOOLS
    ENGINE --> DB_PY
    TOOLS --> CSV
    AUTH_PY --> DB_PY

    style Root fill:#f5f5f5,stroke:#333
    style Static fill:#e8f0fe,stroke:#1a73e8
    style Data fill:#e8f5e9,stroke:#1e8e3e
    style Docs fill:#fff3e0,stroke:#f9ab00
    style Runtime fill:#fce4ec,stroke:#999,stroke-dasharray: 5 5
```

## 8. Tool System Architecture

```mermaid
graph TB
    subgraph Definition["Tool Definition Layer"]
        TD["TOOL_DEFINITIONS<br/>(agent_engine.py)<br/>JSON schemas for Claude API"]
    end

    subgraph Execution["Tool Execution Layer"]
        TM["TOOL_MAP<br/>(agent_engine.py)<br/>name → function mapping"]
    end

    subgraph Functions["Tool Functions (tools.py)"]
        direction LR
        subgraph DataTools["Data Query Tools"]
            CD["contar_defeitos()"]
            TP["top_defeitos()"]
            DT["defeitos_por_turno()"]
        end
        subgraph RenderTools["Render Tools (pass-through)"]
            GG["gerar_grafico()"]
            GT["gerar_tabela()"]
            GK["gerar_kpi()"]
            GD["gerar_dashboard()"]
        end
    end

    subgraph Config["Agent Configuration (DB)"]
        AG["agentes.tools<br/>JSON array: ['contar_defeitos', 'gerar_grafico', ...]"]
    end

    subgraph Admin["Admin Panel"]
        ADM["Toggle tools per agent<br/>via checkboxes"]
    end

    TD --> |"schema sent to Claude"| CLAUDE["Claude API"]
    CLAUDE --> |"tool_use response"| TM
    TM --> |"dispatch"| Functions
    AG --> |"filter allowed tools"| TD
    ADM --> |"PUT /admin/agentes/:id"| AG
    DataTools --> |"read"| CSV["defeitos.csv"]
    RenderTools --> |"widget config"| SSE["SSE to browser"]

    style DataTools fill:#e8f5e9,stroke:#1e8e3e
    style RenderTools fill:#e8f0fe,stroke:#1a73e8
    style Admin fill:#fce4ec,stroke:#e8453c
```
