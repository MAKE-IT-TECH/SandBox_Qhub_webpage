<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QHub ‚Äî Assistente de Qualidade</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; background: #f5f5f5; color: #1a1a1a; }

        /* Header */
        header { background: #1a1a2e; color: #fff; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
        header h1 { font-size: 18px; font-weight: 600; }
        header .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
        header button { background: rgba(255,255,255,0.15); border: none; color: #fff; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        header button:hover { background: rgba(255,255,255,0.25); }

        /* Layout */
        .app { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 240px; background: #fff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar h2 { font-size: 13px; text-transform: uppercase; color: #888; padding: 16px 16px 8px; letter-spacing: 0.5px; }
        .sidebar .agent-btn, .sidebar .admin-nav-btn { display: block; width: 100%; padding: 10px 16px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; border-left: 3px solid transparent; }
        .sidebar .agent-btn:hover, .sidebar .admin-nav-btn:hover { background: #f0f0f0; }
        .sidebar .agent-btn.active, .sidebar .admin-nav-btn.active { background: #e8f0fe; border-left-color: #1a73e8; font-weight: 600; }
        .sidebar .conversations { flex: 1; overflow-y: auto; }
        .sidebar .conv-item { padding: 8px 16px; font-size: 13px; cursor: pointer; color: #555; border-bottom: 1px solid #f0f0f0; }
        .sidebar .conv-item:hover { background: #f8f8f8; }
        .sidebar .conv-item.active { background: #e8f0fe; color: #1a1a1a; }
        .sidebar .new-conv { margin: 8px 16px; padding: 8px; background: #1a73e8; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .sidebar .new-conv:hover { background: #1557b0; }
        .sidebar .admin-section { border-top: 2px solid #e0e0e0; margin-top: 8px; }

        /* Chat */
        .chat { flex: 1; display: flex; flex-direction: column; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .msg.user { align-self: flex-end; background: #1a73e8; color: #fff; border-bottom-right-radius: 4px; }
        .msg.assistant { align-self: flex-start; background: #fff; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px; }
        .msg.tool { align-self: flex-start; background: #f0f7ff; border: 1px solid #c8ddf5; font-size: 12px; font-family: monospace; color: #555; }
        .msg.error { align-self: center; background: #fee; border: 1px solid #fcc; color: #c00; }

        /* Input */
        .input-area { padding: 16px 20px; background: #fff; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; }
        .input-area input[type="text"] { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .input-area input[type="text"]:focus { border-color: #1a73e8; }
        .input-area button { padding: 10px 20px; background: #1a73e8; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .input-area button:hover { background: #1557b0; }
        .input-area button:disabled { background: #ccc; cursor: not-allowed; }
        .attach-btn { padding: 10px 12px; background: #f0f0f0; color: #555; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .attach-btn:hover { background: #e0e0e0; }
        .attach-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Login */
        .login-overlay { position: fixed; inset: 0; background: #1a1a2e; display: flex; align-items: center; justify-content: center; z-index: 100; }
        .login-box { background: #fff; padding: 40px; border-radius: 12px; width: 360px; }
        .login-box h2 { margin-bottom: 8px; font-size: 22px; }
        .login-box p { color: #666; font-size: 14px; margin-bottom: 24px; }
        .login-box input { width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .login-box button { width: 100%; padding: 10px; background: #1a73e8; color: #fff; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; }
        .login-box button:hover { background: #1557b0; }
        .login-box .error { color: #c00; font-size: 13px; margin-bottom: 12px; display: none; }

        /* Widgets */
        .widget { align-self: flex-start; max-width: 90%; margin: 4px 0; }
        .widget-chart { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 16px; width: 480px; max-width: 100%; }
        .widget-chart canvas { max-height: 300px; }
        .widget-chart h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #1a1a2e; }
        .widget-table { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 16px; max-width: 100%; overflow-x: auto; }
        .widget-table h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #1a1a2e; }
        .widget-table table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .widget-table th { background: #f5f7fa; padding: 8px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e0e0e0; color: #555; }
        .widget-table td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; }
        .widget-table tr:hover td { background: #f8f9fa; }
        .widget-kpi { background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; border-radius: 12px; padding: 20px 28px; display: inline-block; min-width: 180px; }
        .widget-kpi .kpi-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 4px; }
        .widget-kpi .kpi-value { font-size: 32px; font-weight: 700; line-height: 1.2; }
        .widget-kpi .kpi-unit { font-size: 14px; opacity: 0.7; margin-left: 4px; }
        .widget-kpi .kpi-variation { font-size: 12px; margin-top: 6px; opacity: 0.8; }
        .widget-dashboard { align-self: flex-start; margin: 8px 0; width: 100%; max-width: 95%; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; background: #fff; }
        .dashboard-bar { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: #1a1a2e; color: #fff; }
        .dashboard-bar .dash-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .dashboard-bar .dash-actions { display: flex; gap: 6px; }
        .dashboard-bar .dash-actions button, .dashboard-bar .dash-actions a { background: rgba(255,255,255,0.15); border: none; color: #fff; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; text-decoration: none; }
        .dashboard-bar .dash-actions button:hover, .dashboard-bar .dash-actions a:hover { background: rgba(255,255,255,0.3); }
        .dashboard-iframe { width: 100%; border: none; min-height: 200px; max-height: 800px; transition: height 0.2s ease; display: block; }
        .dashboard-iframe.collapsed { display: none; }
        .widget-artifact { align-self: flex-start; margin: 8px 0; width: 100%; max-width: 95%; border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; background: #fff; }
        .artifact-bar { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .artifact-lang { font-size: 11px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 0.6px; background: #e8eaf0; padding: 2px 8px; border-radius: 4px; }
        .artifact-actions { display: flex; gap: 6px; }
        .artifact-actions button { padding: 4px 10px; font-size: 12px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background: #fff; color: #333; }
        .artifact-actions button:hover { background: #f0f0f0; }
        .artifact-actions .open-btn { color: #1a73e8; border-color: #1a73e8; }
        .artifact-actions .open-btn:hover { background: #e8f0fe; }
        .artifact-iframe { width: 100%; height: 400px; border: none; display: block; }
        .artifact-code { padding: 14px; background: #1e1e2e; }
        .artifact-code pre { color: #cdd6f4; font-size: 12px; white-space: pre-wrap; word-break: break-all; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; margin: 0; }

        /* Admin Panel */
        .admin-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .admin-header { padding: 20px 28px; background: #fff; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; }
        .admin-header h2 { font-size: 20px; font-weight: 600; color: #1a1a2e; }
        .admin-content { flex: 1; overflow-y: auto; padding: 24px 28px; }
        .admin-btn-primary { padding: 8px 18px; background: #1a73e8; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .admin-btn-primary:hover { background: #1557b0; }
        .admin-btn-danger { padding: 6px 14px; background: #e8453c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .admin-btn-danger:hover { background: #c5342c; }
        .admin-btn-secondary { padding: 6px 14px; background: #f0f0f0; color: #333; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .admin-btn-secondary:hover { background: #e0e0e0; }

        /* Admin cards list */
        .admin-list { display: flex; flex-direction: column; gap: 12px; }
        .admin-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; }
        .admin-card:hover { border-color: #c0c0c0; }
        .admin-card .card-info { flex: 1; }
        .admin-card .card-info .card-name { font-size: 15px; font-weight: 600; color: #1a1a2e; }
        .admin-card .card-info .card-meta { font-size: 12px; color: #888; margin-top: 2px; }
        .admin-card .card-actions { display: flex; gap: 6px; }

        /* Admin form */
        .admin-form { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 24px; max-width: 700px; }
        .admin-form h3 { font-size: 16px; font-weight: 600; margin-bottom: 20px; color: #1a1a2e; }
        .admin-form .form-group { margin-bottom: 16px; }
        .admin-form label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 4px; }
        .admin-form input[type="text"], .admin-form input[type="email"], .admin-form input[type="password"], .admin-form select {
            width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline: none;
        }
        .admin-form input:focus, .admin-form select:focus, .admin-form textarea:focus { border-color: #1a73e8; }
        .admin-form textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; font-family: monospace;
            resize: vertical; min-height: 180px; outline: none; line-height: 1.5;
        }
        .admin-form .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; }
        .admin-form .checkbox-group label { display: flex; align-items: center; gap: 6px; font-weight: 400; font-size: 13px; padding: 4px 10px; background: #f5f7fa; border-radius: 6px; cursor: pointer; border: 1px solid #e0e0e0; }
        .admin-form .checkbox-group label:hover { background: #e8f0fe; }
        .admin-form .checkbox-group input[type="checkbox"] { accent-color: #1a73e8; }
        .admin-form .form-actions { display: flex; gap: 10px; margin-top: 20px; }

        /* Tool cards (read-only) */
        .tool-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 16px 20px; }
        .tool-card .tool-name { font-size: 14px; font-weight: 600; color: #1a73e8; font-family: monospace; }
        .tool-card .tool-desc { font-size: 13px; color: #555; margin-top: 4px; line-height: 1.4; }
        .tool-card .tool-params { margin-top: 8px; font-size: 12px; color: #888; }
        .tool-card .tool-params code { background: #f5f7fa; padding: 1px 5px; border-radius: 3px; font-size: 11px; }

        /* Empty state */
        .empty-state { flex: 1; display: flex; align-items: center; justify-content: center; color: #999; font-size: 15px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Login -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2>QHub</h2>
            <p>Assistente de Qualidade Industrial</p>
            <div class="error" id="loginError"></div>
            <input type="email" id="loginEmail" placeholder="Email" value="maria@demo.com">
            <input type="password" id="loginPassword" placeholder="Password" value="maria123">
            <button onclick="doLogin()">Entrar</button>
        </div>
    </div>

    <!-- App -->
    <header class="hidden" id="appHeader">
        <h1>QHub</h1>
        <div class="user-info">
            <span id="userName"></span>
            <button onclick="doLogout()">Sair</button>
        </div>
    </header>

    <div class="app hidden" id="appBody">
        <div class="sidebar">
            <h2>Agentes</h2>
            <div id="agentList"></div>
            <h2>Conversas</h2>
            <button class="new-conv hidden" id="newConvBtn" onclick="newConversa()">+ Nova conversa</button>
            <div class="conversations" id="convList"></div>

            <!-- Admin nav (hidden for non-admin) -->
            <div class="admin-section hidden" id="adminNav">
                <h2>Admin</h2>
                <button class="admin-nav-btn" onclick="showAdminView('agentes')">Agentes</button>
                <button class="admin-nav-btn" onclick="showAdminView('users')">Utilizadores</button>
                <button class="admin-nav-btn" onclick="showAdminView('tools')">Tools</button>
            </div>
        </div>

        <!-- Chat view -->
        <div class="chat" id="chatView">
            <div class="messages" id="messages">
                <div class="empty-state">Seleciona um agente para come√ßar</div>
            </div>
            <div class="input-area">
                <input type="file" id="fileInput" accept=".csv,.xlsx" style="display:none" onchange="uploadFile()">
                <button class="attach-btn" id="attachBtn" onclick="document.getElementById('fileInput').click()" disabled title="Carregar ficheiro CSV ou Excel">üìé</button>
                <input type="text" id="msgInput" placeholder="Escreve uma mensagem..." onkeydown="if(event.key==='Enter')sendMsg()" disabled>
                <button id="sendBtn" onclick="sendMsg()" disabled>Enviar</button>
            </div>
        </div>

        <!-- Admin panel (hidden by default) -->
        <div class="admin-panel hidden" id="adminPanel">
            <div class="admin-header">
                <h2 id="adminTitle">Admin</h2>
                <div id="adminHeaderActions"></div>
            </div>
            <div class="admin-content" id="adminContent"></div>
        </div>
    </div>

    <script>
        let token = null;
        let currentUser = null;
        let agentes = [];
        let selectedAgente = null;
        let currentConversa = null;
        let sending = false;
        let allTools = []; // Cached from /admin/tools

        const API = '';

        // --- Login / Logout ---

        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errEl = document.getElementById('loginError');
            errEl.style.display = 'none';

            try {
                const res = await fetch(API + '/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                if (!res.ok) { const e = await res.json(); throw new Error(e.detail); }
                const data = await res.json();
                token = data.token;
                currentUser = data;
                showApp();
            } catch (e) {
                errEl.textContent = e.message;
                errEl.style.display = 'block';
            }
        }

        function doLogout() {
            token = null;
            currentUser = null;
            selectedAgente = null;
            currentConversa = null;
            allTools = [];
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('appHeader').classList.add('hidden');
            document.getElementById('appBody').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
        }

        async function showApp() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('appHeader').classList.remove('hidden');
            document.getElementById('appBody').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.nome + ' (' + currentUser.role + ')';

            // Show admin nav if admin
            if (currentUser.role === 'admin') {
                document.getElementById('adminNav').classList.remove('hidden');
            } else {
                document.getElementById('adminNav').classList.add('hidden');
            }

            await loadAgentes();
        }

        // --- Agentes ---

        async function loadAgentes() {
            const res = await fetch(API + '/agentes', {headers: authHeaders()});
            agentes = await res.json();
            const el = document.getElementById('agentList');
            el.innerHTML = '';
            agentes.forEach(a => {
                const btn = document.createElement('button');
                btn.className = 'agent-btn';
                btn.textContent = a.nome;
                btn.onclick = (e) => selectAgente(a, e.target);
                el.appendChild(btn);
            });
        }

        function selectAgente(a, btnEl) {
            selectedAgente = a;
            // Clear active states
            document.querySelectorAll('.agent-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');
            document.getElementById('newConvBtn').classList.remove('hidden');
            currentConversa = null;

            // Switch to chat view
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');

            loadConversas();
            showEmpty('Clica em "+ Nova conversa" para come√ßar');
            setInputEnabled(false);
        }

        // --- Conversas ---

        async function loadConversas() {
            const res = await fetch(API + '/conversas', {headers: authHeaders()});
            const all = await res.json();
            const filtered = all.filter(c => c.agente_id === selectedAgente.id);
            const el = document.getElementById('convList');
            el.innerHTML = '';
            filtered.forEach(c => {
                const div = document.createElement('div');
                div.className = 'conv-item';
                div.textContent = formatDate(c.created_at);
                div.onclick = () => openConversa(c.id);
                el.appendChild(div);
            });
        }

        async function newConversa() {
            if (!selectedAgente) return;
            const res = await fetch(API + '/conversas', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', ...authHeaders()},
                body: JSON.stringify({agente_id: selectedAgente.id})
            });
            const c = await res.json();
            currentConversa = c.id;
            await loadConversas();
            clearMessages();
            setInputEnabled(true);
            highlightConv();
        }

        async function openConversa(id) {
            currentConversa = id;
            highlightConv();
            clearMessages();
            setInputEnabled(true);
            const res = await fetch(API + `/conversas/${id}/mensagens`, {headers: authHeaders()});
            const msgs = await res.json();
            msgs.forEach(m => addMessage(m.role, m.content));
            scrollDown();
        }

        function highlightConv() {
            document.querySelectorAll('.conv-item').forEach((el, i) => {});
        }

        // --- Mensagens ---

        async function sendMsg() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text || !currentConversa || sending) return;

            sending = true;
            input.value = '';
            setInputEnabled(false);
            addMessage('user', text);
            scrollDown();

            const assistantEl = addMessage('assistant', '');

            try {
                const res = await fetch(API + `/conversas/${currentConversa}/mensagens`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', ...authHeaders()},
                    body: JSON.stringify({content: text})
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let accText = '';

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, {stream: true});

                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        try {
                            const evt = JSON.parse(line.slice(6));
                            if (evt.type === 'text') {
                                accText += evt.content;
                                assistantEl.textContent += evt.content;
                                scrollDown();
                            } else if (evt.type === 'chart') {
                                renderChart(evt.data);
                            } else if (evt.type === 'table') {
                                renderTable(evt.data);
                            } else if (evt.type === 'kpi') {
                                renderKpi(evt.data);
                            } else if (evt.type === 'dashboard') {
                                renderDashboardLink(evt.url, evt.titulo);
                            } else if (evt.type === 'tool_use') {
                                addMessage('tool', `üîß ${evt.name}()`);
                                scrollDown();
                            } else if (evt.type === 'error') {
                                addMessage('error', evt.content);
                            }
                        } catch (_) {}
                    }
                }
                postProcessArtifacts(assistantEl, accText);
            } catch (e) {
                addMessage('error', 'Erro de liga√ß√£o: ' + e.message);
            }

            sending = false;
            setInputEnabled(true);
            document.getElementById('msgInput').focus();
        }

        // --- Widget Rendering ---

        const CHART_COLORS = ['#1a73e8','#e8453c','#f9ab00','#1e8e3e','#a142f4','#e8710a','#12b5cb','#f538a0'];

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        function renderChart(data) {
            if (typeof Chart === 'undefined' || !data.etiquetas || data.etiquetas.length === 0) {
                addMessage('tool', '[Gr√°fico indispon√≠vel]');
                return;
            }
            const container = document.createElement('div');
            container.className = 'widget widget-chart';
            const title = document.createElement('h3');
            title.textContent = data.titulo;
            container.appendChild(title);
            const canvas = document.createElement('canvas');
            canvas.id = 'chart-' + Date.now() + '-' + Math.random().toString(36).slice(2,7);
            container.appendChild(canvas);
            document.getElementById('messages').appendChild(container);
            scrollDown();

            requestAnimationFrame(() => {
                const isPie = data.tipo === 'pie' || data.tipo === 'doughnut';
                new Chart(canvas.getContext('2d'), {
                    type: data.tipo,
                    data: {
                        labels: data.etiquetas,
                        datasets: [{
                            label: data.dataset_label || data.titulo,
                            data: data.valores,
                            backgroundColor: isPie ? CHART_COLORS.slice(0, data.etiquetas.length) : CHART_COLORS[0],
                            borderColor: isPie ? '#fff' : CHART_COLORS[0],
                            borderWidth: isPie ? 2 : 1,
                            borderRadius: isPie ? 0 : 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: isPie, position: 'bottom' },
                        },
                        scales: isPie ? {} : {
                            y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                            x: { grid: { display: false } },
                        }
                    }
                });
            });
        }

        function renderTable(data) {
            const container = document.createElement('div');
            container.className = 'widget widget-table';
            let html = `<h3>${escapeHtml(data.titulo)}</h3><table><thead><tr>`;
            data.colunas.forEach(c => html += `<th>${escapeHtml(c)}</th>`);
            html += '</tr></thead><tbody>';
            data.linhas.forEach(row => {
                html += '<tr>';
                row.forEach(cell => html += `<td>${escapeHtml(String(cell))}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            document.getElementById('messages').appendChild(container);
            scrollDown();
        }

        function renderKpi(data) {
            const container = document.createElement('div');
            container.className = 'widget widget-kpi';
            container.innerHTML = `
                <div class="kpi-title">${escapeHtml(data.titulo)}</div>
                <div class="kpi-value">${escapeHtml(data.valor)}<span class="kpi-unit">${escapeHtml(data.unidade || '')}</span></div>
                ${data.variacao ? '<div class="kpi-variation">' + escapeHtml(data.variacao) + '</div>' : ''}
            `;
            document.getElementById('messages').appendChild(container);
            scrollDown();
        }

        function renderDashboardLink(url, titulo) {
            const container = document.createElement('div');
            container.className = 'widget widget-dashboard';

            const iframeId = 'dash-' + Date.now() + '-' + Math.random().toString(36).slice(2,7);

            container.innerHTML = `
                <div class="dashboard-bar">
                    <span class="dash-title">üìä ${escapeHtml(titulo)}</span>
                    <div class="dash-actions">
                        <button onclick="toggleDashboard('${iframeId}')" title="Recolher/Expandir">‚ñº</button>
                        <a href="${escapeHtml(url)}" target="_blank" title="Abrir em nova janela">‚Üó</a>
                    </div>
                </div>
                <iframe id="${iframeId}" src="${escapeHtml(url)}" sandbox="allow-scripts" class="dashboard-iframe"></iframe>
            `;
            document.getElementById('messages').appendChild(container);
            scrollDown();
        }

        function toggleDashboard(iframeId) {
            const iframe = document.getElementById(iframeId);
            const btn = iframe.previousElementSibling.querySelector('.dash-actions button');
            if (iframe.classList.contains('collapsed')) {
                iframe.classList.remove('collapsed');
                btn.textContent = '‚ñº';
            } else {
                iframe.classList.add('collapsed');
                btn.textContent = '‚ñ∂';
            }
        }

        // --- Artifact Renderer ---

        function postProcessArtifacts(el, text) {
            const ARTIFACT_RE = /```(html|svg|jsx)\n([\s\S]*?)```/g;
            if (!ARTIFACT_RE.test(text)) return;
            ARTIFACT_RE.lastIndex = 0;

            el.textContent = '';
            let lastIndex = 0;
            let match;
            while ((match = ARTIFACT_RE.exec(text)) !== null) {
                const before = text.slice(lastIndex, match.index);
                if (before.trim()) {
                    const div = document.createElement('div');
                    div.style.whiteSpace = 'pre-wrap';
                    div.textContent = before;
                    el.appendChild(div);
                }
                el.appendChild(createArtifactWidget(match[1], match[2].trim()));
                lastIndex = match.index + match[0].length;
            }
            const after = text.slice(lastIndex);
            if (after.trim()) {
                const div = document.createElement('div');
                div.style.whiteSpace = 'pre-wrap';
                div.textContent = after;
                el.appendChild(div);
            }
            scrollDown();
        }

        function createArtifactWidget(lang, code) {
            const id = 'art-' + Date.now() + '-' + Math.random().toString(36).slice(2, 7);
            const container = document.createElement('div');
            container.className = 'widget-artifact';

            let srcdoc = null;
            if (lang === 'svg') {
                srcdoc = `<!DOCTYPE html><html><body style="margin:0;background:#fff">${code}</body></html>`;
            } else if (lang === 'html') {
                srcdoc = code.trimStart().startsWith('<!') ? code :
                    `<!DOCTYPE html><html><head><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"><\/script></head><body>${code}</body></html>`;
            }

            const canRender = srcdoc !== null;
            const displayLang = lang === 'jsx' ? 'JSX' : lang.toUpperCase();

            container.innerHTML = `
                <div class="artifact-bar">
                    <span class="artifact-lang">${escapeHtml(displayLang)}</span>
                    <div class="artifact-actions">
                        ${canRender ? `<button onclick="toggleArtifactView('${id}')">C√≥digo</button>` : ''}
                        ${canRender ? `<button class="open-btn" onclick="openArtifactTab('${id}')">‚Üó Abrir</button>` : ''}
                    </div>
                </div>
                ${canRender ? `<div id="art-render-${id}"><iframe id="art-iframe-${id}" srcdoc="" sandbox="allow-scripts" class="artifact-iframe"></iframe></div>` : ''}
                <div id="art-code-${id}" class="${canRender ? 'artifact-code hidden' : 'artifact-code'}">
                    <pre>${escapeHtml(code)}</pre>
                </div>
            `;

            if (canRender) {
                requestAnimationFrame(() => {
                    const iframe = document.getElementById('art-iframe-' + id);
                    if (iframe) iframe.srcdoc = srcdoc;
                });
            }

            return container;
        }

        function toggleArtifactView(id) {
            const renderEl = document.getElementById('art-render-' + id);
            const codeEl = document.getElementById('art-code-' + id);
            const btn = renderEl.previousElementSibling.querySelector('button');
            if (codeEl.classList.contains('hidden')) {
                codeEl.classList.remove('hidden');
                renderEl.classList.add('hidden');
                if (btn) btn.textContent = 'Render';
            } else {
                codeEl.classList.add('hidden');
                renderEl.classList.remove('hidden');
                if (btn) btn.textContent = 'C√≥digo';
            }
        }

        function openArtifactTab(id) {
            const iframe = document.getElementById('art-iframe-' + id);
            if (!iframe || !iframe.srcdoc) return;
            const blob = new Blob([iframe.srcdoc], {type: 'text/html'});
            window.open(URL.createObjectURL(blob), '_blank');
        }

        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'dashboard-height' && typeof e.data.height === 'number') {
                const iframes = document.querySelectorAll('.dashboard-iframe');
                for (const iframe of iframes) {
                    if (iframe.contentWindow === e.source) {
                        iframe.style.height = Math.min(e.data.height + 20, 800) + 'px';
                        scrollDown();
                        break;
                    }
                }
            }
        });

        // ========================================
        // ADMIN PANEL
        // ========================================

        function showAdminView(view) {
            // Clear active states
            document.querySelectorAll('.agent-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
            // Highlight clicked nav
            const btns = document.querySelectorAll('.admin-nav-btn');
            const map = {agentes: 0, users: 1, tools: 2};
            if (btns[map[view]]) btns[map[view]].classList.add('active');

            // Switch views
            document.getElementById('chatView').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');

            if (view === 'agentes') loadAdminAgentes();
            else if (view === 'users') loadAdminUsers();
            else if (view === 'tools') loadAdminTools();
        }

        // --- Admin: Agentes ---

        async function loadAdminAgentes() {
            document.getElementById('adminTitle').textContent = 'Gerir Agentes';
            document.getElementById('adminHeaderActions').innerHTML =
                '<button class="admin-btn-primary" onclick="showAgenteForm()">+ Novo Agente</button>';

            const res = await fetch(API + '/admin/agentes', {headers: authHeaders()});
            const agentes = await res.json();

            // Also load tools for reference
            if (allTools.length === 0) {
                const tr = await fetch(API + '/admin/tools', {headers: authHeaders()});
                allTools = await tr.json();
            }

            const el = document.getElementById('adminContent');
            if (agentes.length === 0) {
                el.innerHTML = '<div class="empty-state">Nenhum agente criado</div>';
                return;
            }

            let html = '<div class="admin-list">';
            agentes.forEach(a => {
                const toolCount = a.tools.length;
                const promptPreview = a.system_prompt.substring(0, 80) + (a.system_prompt.length > 80 ? '...' : '');
                html += `
                    <div class="admin-card">
                        <div class="card-info">
                            <div class="card-name">${escapeHtml(a.nome)}</div>
                            <div class="card-meta">${toolCount} tool(s) ‚Äî ${escapeHtml(promptPreview)}</div>
                        </div>
                        <div class="card-actions">
                            <button class="admin-btn-secondary" onclick="showAgenteForm(${a.id})">Editar</button>
                            <button class="admin-btn-danger" onclick="deleteAgente(${a.id}, '${escapeHtml(a.nome)}')">Apagar</button>
                        </div>
                    </div>`;
            });
            html += '</div>';
            el.innerHTML = html;
        }

        async function showAgenteForm(agenteId) {
            // Load tools if not cached
            if (allTools.length === 0) {
                const tr = await fetch(API + '/admin/tools', {headers: authHeaders()});
                allTools = await tr.json();
            }

            let agente = {nome: '', system_prompt: '', tools: []};
            if (agenteId) {
                const res = await fetch(API + '/admin/agentes', {headers: authHeaders()});
                const all = await res.json();
                agente = all.find(a => a.id === agenteId) || agente;
            }

            const isEdit = !!agenteId;
            document.getElementById('adminTitle').textContent = isEdit ? 'Editar Agente' : 'Novo Agente';
            document.getElementById('adminHeaderActions').innerHTML =
                '<button class="admin-btn-secondary" onclick="loadAdminAgentes()">Voltar</button>';

            const toolCheckboxes = allTools.map(t => {
                const checked = agente.tools.includes(t.name) ? 'checked' : '';
                return `<label><input type="checkbox" value="${escapeHtml(t.name)}" ${checked}> ${escapeHtml(t.name)}</label>`;
            }).join('');

            document.getElementById('adminContent').innerHTML = `
                <div class="admin-form">
                    <h3>${isEdit ? 'Editar' : 'Criar'} Agente</h3>
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="agenteNome" value="${escapeHtml(agente.nome)}">
                    </div>
                    <div class="form-group">
                        <label>System Prompt (Skills / Comportamento)</label>
                        <textarea id="agentePrompt">${escapeHtml(agente.system_prompt)}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Tools</label>
                        <div class="checkbox-group" id="agenteTools">${toolCheckboxes}</div>
                    </div>
                    <div class="form-actions">
                        <button class="admin-btn-primary" onclick="saveAgente(${agenteId || 'null'})">Guardar</button>
                        <button class="admin-btn-secondary" onclick="loadAdminAgentes()">Cancelar</button>
                    </div>
                </div>`;
        }

        async function saveAgente(agenteId) {
            const nome = document.getElementById('agenteNome').value.trim();
            const system_prompt = document.getElementById('agentePrompt').value.trim();
            const tools = Array.from(document.querySelectorAll('#agenteTools input:checked')).map(cb => cb.value);

            if (!nome || !system_prompt) {
                alert('Nome e System Prompt s√£o obrigat√≥rios.');
                return;
            }

            const body = {nome, system_prompt, tools};
            const method = agenteId ? 'PUT' : 'POST';
            const url = agenteId ? `${API}/admin/agentes/${agenteId}` : `${API}/admin/agentes`;

            const res = await fetch(url, {
                method,
                headers: {'Content-Type': 'application/json', ...authHeaders()},
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const err = await res.json();
                alert('Erro: ' + err.detail);
                return;
            }

            // Refresh agent list in sidebar too
            await loadAgentes();
            loadAdminAgentes();
        }

        async function deleteAgente(agenteId, nome) {
            if (!confirm(`Apagar agente "${nome}"? Isto remove todas as conversas associadas.`)) return;

            const res = await fetch(`${API}/admin/agentes/${agenteId}`, {
                method: 'DELETE',
                headers: authHeaders()
            });

            if (!res.ok) {
                const err = await res.json();
                alert('Erro: ' + err.detail);
                return;
            }

            await loadAgentes();
            loadAdminAgentes();
        }

        // --- Admin: Users ---

        async function loadAdminUsers() {
            document.getElementById('adminTitle').textContent = 'Gerir Utilizadores';
            document.getElementById('adminHeaderActions').innerHTML =
                '<button class="admin-btn-primary" onclick="showUserForm()">+ Novo Utilizador</button>';

            const res = await fetch(API + '/admin/users', {headers: authHeaders()});
            const users = await res.json();

            const el = document.getElementById('adminContent');
            if (users.length === 0) {
                el.innerHTML = '<div class="empty-state">Nenhum utilizador</div>';
                return;
            }

            let html = '<div class="admin-list">';
            users.forEach(u => {
                const roleLabel = {admin: 'Admin', operadora: 'Operadora', responsavel: 'Respons√°vel'}[u.role] || u.role;
                html += `
                    <div class="admin-card">
                        <div class="card-info">
                            <div class="card-name">${escapeHtml(u.nome)}</div>
                            <div class="card-meta">${escapeHtml(u.email)} ‚Äî ${escapeHtml(roleLabel)}</div>
                        </div>
                        <div class="card-actions">
                            <button class="admin-btn-secondary" onclick="showUserForm(${u.id})">Editar</button>
                            <button class="admin-btn-danger" onclick="deleteUser(${u.id}, '${escapeHtml(u.nome)}')">Apagar</button>
                        </div>
                    </div>`;
            });
            html += '</div>';
            el.innerHTML = html;
        }

        async function showUserForm(userId) {
            // Load all agents for assignment
            const agRes = await fetch(API + '/admin/agentes', {headers: authHeaders()});
            const allAgentes = await agRes.json();

            let user = {nome: '', email: '', role: 'operadora'};
            let userAgentes = [];

            if (userId) {
                const usersRes = await fetch(API + '/admin/users', {headers: authHeaders()});
                const allUsers = await usersRes.json();
                user = allUsers.find(u => u.id === userId) || user;

                const uaRes = await fetch(`${API}/admin/users/${userId}/agentes`, {headers: authHeaders()});
                userAgentes = await uaRes.json();
            }

            const isEdit = !!userId;
            document.getElementById('adminTitle').textContent = isEdit ? 'Editar Utilizador' : 'Novo Utilizador';
            document.getElementById('adminHeaderActions').innerHTML =
                '<button class="admin-btn-secondary" onclick="loadAdminUsers()">Voltar</button>';

            const agenteCheckboxes = allAgentes.map(a => {
                const checked = userAgentes.includes(a.id) ? 'checked' : '';
                return `<label><input type="checkbox" value="${a.id}" ${checked}> ${escapeHtml(a.nome)}</label>`;
            }).join('');

            document.getElementById('adminContent').innerHTML = `
                <div class="admin-form">
                    <h3>${isEdit ? 'Editar' : 'Criar'} Utilizador</h3>
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="userNome" value="${escapeHtml(user.nome)}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="userEmail" value="${escapeHtml(user.email)}">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="userRole">
                            <option value="operadora" ${user.role === 'operadora' ? 'selected' : ''}>Operadora</option>
                            <option value="responsavel" ${user.role === 'responsavel' ? 'selected' : ''}>Respons√°vel</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Password ${isEdit ? '(deixar vazio para manter)' : ''}</label>
                        <input type="password" id="userPassword" placeholder="${isEdit ? 'Sem altera√ß√£o' : 'Password'}">
                    </div>
                    <div class="form-group">
                        <label>Agentes acess√≠veis</label>
                        <div class="checkbox-group" id="userAgentes">${agenteCheckboxes || '<span style="color:#888;font-size:13px">Nenhum agente dispon√≠vel</span>'}</div>
                    </div>
                    <div class="form-actions">
                        <button class="admin-btn-primary" onclick="saveUser(${userId || 'null'})">Guardar</button>
                        <button class="admin-btn-secondary" onclick="loadAdminUsers()">Cancelar</button>
                    </div>
                </div>`;
        }

        async function saveUser(userId) {
            const nome = document.getElementById('userNome').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;
            const agenteIds = Array.from(document.querySelectorAll('#userAgentes input:checked')).map(cb => parseInt(cb.value));

            if (!nome || !email) {
                alert('Nome e Email s√£o obrigat√≥rios.');
                return;
            }
            if (!userId && !password) {
                alert('Password √© obrigat√≥ria para novos utilizadores.');
                return;
            }

            const body = {nome, email, role};
            if (password) body.password = password;

            const method = userId ? 'PUT' : 'POST';
            const url = userId ? `${API}/admin/users/${userId}` : `${API}/admin/users`;

            const res = await fetch(url, {
                method,
                headers: {'Content-Type': 'application/json', ...authHeaders()},
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const err = await res.json();
                alert('Erro: ' + err.detail);
                return;
            }

            // Get user ID for new users
            let targetUserId = userId;
            if (!userId) {
                const data = await res.json();
                targetUserId = data.id;
            }

            // Set agent assignments
            await fetch(`${API}/admin/users/${targetUserId}/agentes`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json', ...authHeaders()},
                body: JSON.stringify({agente_ids: agenteIds})
            });

            loadAdminUsers();
        }

        async function deleteUser(userId, nome) {
            if (!confirm(`Apagar utilizador "${nome}"? Isto remove todas as conversas e dados associados.`)) return;

            const res = await fetch(`${API}/admin/users/${userId}`, {
                method: 'DELETE',
                headers: authHeaders()
            });

            if (!res.ok) {
                const err = await res.json();
                alert('Erro: ' + err.detail);
                return;
            }

            loadAdminUsers();
        }

        // --- Admin: Tools ---

        async function loadAdminTools() {
            document.getElementById('adminTitle').textContent = 'Tools Dispon√≠veis';
            document.getElementById('adminHeaderActions').innerHTML =
                '<span style="font-size:12px;color:#888">As tools s√£o definidas em c√≥digo Python</span>';

            if (allTools.length === 0) {
                const res = await fetch(API + '/admin/tools', {headers: authHeaders()});
                allTools = await res.json();
            }

            const el = document.getElementById('adminContent');
            let html = '<div class="admin-list">';
            allTools.forEach(t => {
                const params = Object.entries(t.parameters || {});
                let paramsHtml = '';
                if (params.length > 0) {
                    paramsHtml = '<div class="tool-params">Par√¢metros: ' +
                        params.map(([k, v]) => `<code>${escapeHtml(k)}</code> (${escapeHtml(v.type || '?')})`).join(', ') +
                        '</div>';
                }
                html += `
                    <div class="tool-card">
                        <div class="tool-name">${escapeHtml(t.name)}</div>
                        <div class="tool-desc">${escapeHtml(t.description)}</div>
                        ${paramsHtml}
                    </div>`;
            });
            html += '</div>';
            el.innerHTML = html;
        }

        // --- Upload de Ficheiros ---

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file || !currentConversa) return;

            setInputEnabled(false);
            const processingMsg = addMessage('tool', `üìé A processar ${file.name}...`);
            scrollDown();

            try {
                const formData = new FormData();
                formData.append('file', file);
                const res = await fetch(API + `/conversas/${currentConversa}/upload`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: formData,
                });
                const data = await res.json();
                if (!res.ok) {
                    processingMsg.textContent = `‚ùå Erro: ${data.detail || 'Erro ao carregar ficheiro'}`;
                    processingMsg.className = 'msg error';
                } else {
                    processingMsg.textContent = `üìé ${data.resumo}`;
                    document.getElementById('msgInput').focus();
                }
            } catch (e) {
                processingMsg.textContent = `‚ùå Erro de liga√ß√£o: ${e.message}`;
                processingMsg.className = 'msg error';
            }

            fileInput.value = '';
            setInputEnabled(true);
            scrollDown();
        }

        // --- UI Helpers ---

        function addMessage(role, text) {
            const el = document.getElementById('messages');
            const empty = el.querySelector('.empty-state');
            if (empty) empty.remove();

            const div = document.createElement('div');
            div.className = 'msg ' + role;
            div.textContent = text;
            el.appendChild(div);
            return div;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function showEmpty(text) {
            const el = document.getElementById('messages');
            el.innerHTML = `<div class="empty-state">${text}</div>`;
        }

        function scrollDown() {
            const el = document.getElementById('messages');
            el.scrollTop = el.scrollHeight;
        }

        function setInputEnabled(enabled) {
            document.getElementById('msgInput').disabled = !enabled;
            document.getElementById('sendBtn').disabled = !enabled;
            document.getElementById('attachBtn').disabled = !enabled;
        }

        function authHeaders() {
            return token ? {'Authorization': 'Bearer ' + token} : {};
        }

        function formatDate(iso) {
            const d = new Date(iso);
            return d.toLocaleDateString('pt-PT') + ' ' + d.toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit'});
        }
    </script>
</body>
</html>
